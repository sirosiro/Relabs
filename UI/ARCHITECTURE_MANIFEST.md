# UI Module Architecture Manifest

## Part 1: Module Guide
このディレクトリ (`UI/`) は、ユーザーとの対話を担当するプレゼンテーション層です。
`PySide6` (Qt) をフレームワークとして採用し、ユーザーの操作を解釈して `Core` や `Service` に伝達し、その結果を視覚化します。

---

## Part 2: Module Content

### 1. 核となる原則 (Core Principles)
*   **View**: モデルの状態をユーザーに提示する（3D描画、数値表示）。
*   **Controller**: ユーザー入力を受け取り、モデルやサービスの更新メソッドを呼び出す。
*   **Layout**: ウィンドウやウィジェットの配置管理。

### 2. 主要なアーキテクチャ決定の記録 (Key Architectural Decisions)
<!--
Date: 2026-01-31
Decision: OpenGL固定機能パイプラインの採用
Rationale: 現在の要件（単純な立方体の表示）に対し、シェーダーベースの実装はコード量と複雑さが増すため、開発速度と可読性を優先して固定機能 (`glBegin`/`glEnd`) を採用した。将来的に複雑化した場合はVBO/Shaderへの移行を検討する。

Date: 2026-01-31
Decision: 高DPI対応 (devicePixelRatio)
Rationale: Mac Retinaディスプレイ等でクリック判定がずれる問題に対処するため、論理ピクセルから物理ピクセルへの変換ロジックをViewportに組み込んだ。

Date: 2026-01-31
Decision: 視覚的補助（グリッドとズームスライダー）の導入
Rationale: 3D空間でのスケール感と操作性を向上させるため。特に絶対座標を扱う本アプリにおいて、空間的な位置関係を直感的に把握するためのXZグリッドとY軸スケールは必須と判断した。

Date: 2026-01-31
Decision: Object Modeの導入
Rationale: Coreのデータ構造が頂点インスタンスを共有しておらず、面単位の編集しかできない制約をUI側で回避するため。モデル全体の重心を基準とした移動機能を提供することで、オブジェクト単位の操作性を確保した。これはデータ構造の制約に対する戦術的な対応である。
-->

### 3. AIとの協調に関する指針 (AI Collaboration Policy)
*   **メインスレッド保護**: ファイル入出力や重い計算を行う際は、UIをフリーズさせないよう注意すること。
*   **リソース管理**: OpenGLリソースやQtウィジェットは、PythonのGCだけでなく、親ウィジェットの破棄や明示的な終了処理が必要な場合があることに留意すること。

### 4. コンポーネント詳細 (Components)

#### 4.1. Main Window (`main_window.py`)
*   **役割**: アプリケーションのシェル。レイアウトと依存性注入のエントリーポイント。
*   **イベント連携**: ViewportとControlPanel間の直接参照を避け、MainWindowがシグナル/スロットを中継する。

#### 4.2. 3D Viewport (`viewport.py`)
*   **役割**: OpenGLを用いた3Dモデルのレンダリングとマウス操作。
*   **実装詳細**:
    *   **ギズモ**: 2Dオーバーレイとして座標軸を描画。
    *   **グリッド**: XZ平面の基準線と、Y軸方向の目盛りを表示し、空間スケールを提供。

#### 4.3. Control Panel (`control_panel.py`)
*   **役割**: 選択された面の数値編集、モデル全体の編集、および表示設定の管理。
*   **編集モード**:
    *   **Face Mode**: 選択された単一の面の頂点座標を直接編集する。
    *   **Object Mode**: モデル全体の重心を基準に、オブジェクト全体を平行移動させる。
*   **表示設定**: グリッドのON/OFF、ズームレベルのスライダー制御を提供。
*   **UX**: 頂点ごとにグループ化し、X/Y/Zを色分けして表示（ギズモと対応）。
*   **循環参照防止**: `_updating_ui` フラグによる保護。

#### 4.4. Dialogs
*   **`ExportDialog`**: エクスポート設定の入力フォーム。